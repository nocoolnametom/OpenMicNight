<?php

/**
 * Email
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    OpenMicNight
 * @subpackage model
 * @author     Tom Doggett
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Email extends BaseEmail
{
    protected $app_name;
    protected $user;
    protected $name;

    protected function prepare($user_id)
    {
        $this->app_name = ProjectConfiguration::getApplicationName();
        $this->user = sfGuardUserTable::getInstance()->find($user_id);
        if (!$this->user)
            throw new sfException('Cannot find User identified by ' . $user_id);
        $this->name = ($this->user->getPreferredName() ?
                        $this->user->getPreferredName() : $this->user->getFullName());
    }

    public function generateBodyText($parameters, $html = true)
    {
        $this->prepare($parameters['user_id']);

        if ($html) {
            $body = $this->getBodyTextHtml();
        } elseif ($this->getBodyText()) {
            $body = $this->getBodyText();
        } else {
            $body = $this->getBodyTextHtml();
            $body = preg_replace('~<br/?>~', "\n", $body);
            $body = strip_tags($body);
        }

        $pattern = '/~([a-z_\-]+)~/';
        preg_match_all($pattern, $body, $matches);
        foreach ($matches[1] as $key => $match) {
            $function = 'derive' . str_replace(' ', '', ucwords(str_replace('_', ' ', $match)));
            $replacement = $this->{$function}($parameters);
            $body = str_replace($matches[0][$key], $replacement, $body);
        }
        
        return $body;
    }
    
    public function generateSubject($parameters)
    {
        $this->prepare($parameters['user_id']);

        $subject = $this->getSubject();

        $pattern = '/~([a-z_\-]+)~/';
        preg_match_all($pattern, $subject, $matches);
        foreach ($matches[1] as $key => $match) {
            $function = 'derive' . str_replace(' ', '', ucwords(str_replace('_', ' ', $match)));
            $replacement = $this->{$function}($parameters);
            $subject = str_replace($matches[0][$key], $replacement, $subject);
        }
        
        return $subject;
    }

    protected function deriveName($parameters)
    {
        return $this->name;
    }

    protected function deriveAppName($parameters)
    {
        return $this->app_name;
    }

    protected function deriveApiName($parameters)
    {
        $api_id = $parameters['api_id'];
        $api = ApiKeyTable::getInstance()->find($api_id);
        if (!$api)
            throw new sfException('Cannot find ApiKey identified by ' . $api_id);
        return $api->getApiAppName();
    }

    protected function deriveValidKey($parameters)
    {
        return $this->user->getRedditValidationKey();
    }

    protected function deriveSubredditName($parameters)
    {
        $episode_id = $parameters['episode_id'];
        $episode = EpisodeTable::getInstance()->find($episode_id);
        if (!$episode)
            throw new sfException('Cannot find Episode identified by ' . $episode_id);
        return $episode->getSubreddit()->getName();
    }

    protected function deriveRedditPost($parameters)
    {
        $authorization_key = $this->user->getEmailAuthorizationKey();

        $frontend_app_location = rtrim(ProjectConfiguration::getFrontendAppLocation(),
                                       '/');
        $frontendRouting = new sfPatternRouting(new sfEventDispatcher());

        $config = new sfRoutingConfigHandler();
        $routes = $config->evaluate(array(sfConfig::get('sf_apps_dir') . '/frontend/config/routing.yml'));

        $frontendRouting->setRoutes($routes);

        $frontend_route = $frontend_app_location . $frontendRouting
                        ->generate('send_to_reddit_post');
        return $frontend_route;
    }
    
    protected function deriveEditLink($parameters)
    {
        $episode_id = $parameters['episode_id'];
        $episode = EpisodeTable::getInstance()->find($episode_id);
        if (!$episode)
            throw new sfException('Cannot find Episode identified by ' . $episode_id);

        $frontend_app_location = rtrim(ProjectConfiguration::getFrontendAppLocation(),
                                       '/');
        $frontendRouting = new sfPatternRouting(new sfEventDispatcher());

        $config = new sfRoutingConfigHandler();
        $routes = $config->evaluate(array(sfConfig::get('sf_apps_dir') . '/frontend/config/routing.yml'));

        $frontendRouting->setRoutes($routes);

        $frontend_route = $frontend_app_location . $frontendRouting
                        ->generate('episode_edit', array(
                            'id' => $episode_id,
                        ), true);
        return $frontend_route;
    }
    
    protected function derivePersonalEpisodesLink($parameters)
    {
        $episode_id = $parameters['episode_id'];
        $episode = EpisodeTable::getInstance()->find($episode_id);
        if (!$episode)
            throw new sfException('Cannot find Episode identified by ' . $episode_id);

        $frontend_app_location = rtrim(ProjectConfiguration::getFrontendAppLocation(),
                                       '/');
        $frontendRouting = new sfPatternRouting(new sfEventDispatcher());

        $config = new sfRoutingConfigHandler();
        $routes = $config->evaluate(array(sfConfig::get('sf_apps_dir') . '/frontend/config/routing.yml'));

        $frontendRouting->setRoutes($routes);

        $frontend_route = $frontend_app_location . $frontendRouting
                        ->generate('profile_episodes', array(), true);
        return $frontend_route;
    }

    protected function deriveSenderUsername($parameters)
    {
        $message_id = $parameters['message_id'];
        $message = MessageTable::getInstance()->find($message_id);
        if (!$message)
            throw new sfException('Cannot find Message identified by ' . $message_id);
        $sender = sfGuardUserTable::getInstance()->find($message->getSenderId());
        return $sender->getUsername();
    }

    protected function deriveNewPassword($parameters)
    {
        return $parameters['new_password'];
    }

    protected function deriveMessageText($parameters)
    {
        $message_id = $parameters['message_id'];
        $message = MessageTable::getInstance()->find($message_id);
        if (!$message)
            throw new sfException('Cannot find Message identified by ' . $message_id);
        return $message->getText();
    }

    protected function deriveReleaseDate($parameters)
    {
        $episode_id = $parameters['episode_id'];
        $episode = EpisodeTable::getInstance()->find($episode_id);
        if (!$episode)
            throw new sfException('Cannot find Episode identified by ' . $episode_id);
        return date('l, F j, Y \a\t g:ia', strtotime($episode->getReleaseDate()));
    }

    protected function deriveDeadlineDate($parameters)
    {
        $deadline = $parameters['deadline'];
        return date('l, F j, Y \a\t g:ia', strtotime($deadline));
    }

    protected function deriveFrontendRoute($parameters)
    {
        $authorization_key = $this->user->getEmailAuthorizationKey();

        $frontend_app_location = rtrim(ProjectConfiguration::getFrontendAppLocation(),
                                       '/');
        $frontendRouting = new sfPatternRouting(new sfEventDispatcher());

        $config = new sfRoutingConfigHandler();
        $routes = $config->evaluate(array(sfConfig::get('sf_apps_dir') . '/frontend/config/routing.yml'));

        $frontendRouting->setRoutes($routes);

        $frontend_route = $frontend_app_location . $frontendRouting
                        ->generate('sf_guard_verify',
                                   array(
                            'key' => $authorization_key,
                        ));
        return $frontend_route;
    }
    
    
}
