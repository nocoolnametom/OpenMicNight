<?php

/**
 * SubredditTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class SubredditTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object SubredditTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Subreddit');
    }
    
    public function getSubredditsNeedingEpisodeGeneration($subreddit_name = '%')
    {
        $subquery = $this->createQuery()
                ->select('E.subreddit_id')
                ->from('Episode E')
                ->leftJoin('Subreddit S')
                ->groupBy('E.subreddit_id')
                ->where('E.release_date > TIMESTAMPADD(SECOND, S.creation_interval, NOW())')
                ->fetchArray();
        $ids = array();
        foreach($subquery as $entry)
        {
            $id[] = $entry['subreddit_id'];
        }
        $subreddits = @$this->createQuery()
                ->where('Subreddit.name LIKE :name',
                        array(':name' => $subreddit_name))
                ->whereNotIn('Subreddit.id', $ids)
                ->execute();
        
        return $subreddits;
    }
}